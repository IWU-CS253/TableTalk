{% extends "layout.html" %}

{% block content %}

<! Section to flash bootstrap alerts>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}


<div class="container-fluid mt-4">
  <div class="row">
    <! Sidebar for Friend Cards>
    <div class="col-md-3">
      <h5 class="mb-3">Suggested Friends</h5>
      <ul class="list-group">

          <! Display all friends which are not the current user logged in>
          {% for friend in suggested_friends %}
              <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">

                  <! Keep working on this>
                  <a href="{{ url_for('show_user_profile', username=friend.username) }}" class="text-success text-decoration-none">
                    <strong>{{ friend.first_name }} {{ friend.last_name }}</strong>
                  </a>

                  <! This does not do anything yet>
                  <button class="btn btn-outline-success">Add Friend</button>
                </div>
                <div class="ms-4" style="text-align: left">@{{ friend.username }}</div>
                <div class="ms-4"style="text-align: left">My favorite food is: {{ friend.favorite_food }}</div>
              </li>
          {% endfor %}
      </ul>
      </ul>
    </div>

    <! Main Feed Section>
    <div class="col-md-9">
      <h5 class="mb-3">Main Feed</h5>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#recipeModal">Add New Recipe</button>

        <! Ability to filter posts to a users liking and the default shows all posts>
        <form method="get" action="{{ url_for('filter_posts') }}" class="d-flex align-items-center mb-3">
          <select name="filter_category" class="form-select w-auto me-2" data-role="filter">
            <option value="FILTER POSTS" {% if selected_category == 'FILTER POSTS' or not selected_category %}selected{% endif %}>FILTER POSTS</option>
            <option value="American" {% if selected_category == 'American' %}selected{% endif %}>American</option>
            <option value="Chinese" {% if selected_category == 'Chinese' %}selected{% endif %}>Chinese</option>
            <option value="Greek" {% if selected_category == 'Greek' %}selected{% endif %}>Greek</option>
            <option value="Indian" {% if selected_category == 'Indian' %}selected{% endif %}>Indian</option>
            <option value="Italian (Pizza)" {% if selected_category == 'Italian (Pizza)' %}selected{% endif %}>Italian (Pizza)</option>
            <option value="Italian (Pasta)" {% if selected_category == 'Italian (Pasta)' %}selected{% endif %}>Italian (Pasta)</option>
            <option value="Mexican" {% if selected_category == 'Mexican' %}selected{% endif %}>Mexican</option>
            <option value="Seafood" {% if selected_category == 'Seafood' %}selected{% endif %}>Seafood</option>
            <option value="Other" {% if selected_category == 'Other' %}selected{% endif %}>Other</option>
          </select>
        </form>
      </div>

      <! Display all the posts in the database>
      {% for post in posts %}
      <div class="card mb-4">
        <div class="card-header">
          <strong>{{ post.username }}</strong> ({{ post.category }})
        </div>

        <div class="card-body">
          <! Div with a button to the right side so the user can click and see the recipe more fully>
          <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title text-success fw-bold mb-0">{{ post.title }}</h5>
              <a href="{{ url_for('view_recipe', recipe_id=post.id) }}" class="btn btn-outline-success btn-sm">View Recipe</a>
          </div>
          <div class="mb-2"><strong>Category:</strong> {{ post.category }}</div>
          <! Choosing not to display the steps on the main feed page because this allows more posts to be seen at once, and entices users to click into the recipe>

          <! Display all the Ingredients>
          <p><strong>Ingredients:</strong></p>
          <ul class="list-group mb-3">
            {% for ingredient in post.ingredients.split('\n') %}
            <li class="list-group-item">{{ ingredient }}</li>
            {% endfor %}
          </ul>

          <! Display needed appliances>
          <p><strong>Appliances Needed:</strong></p>
          <ul class="list-group mb-3">
            {% for appliance in post.appliances.split('\n') %}
            <li class="list-group-item">{{ appliance }}</li>
            {% endfor %}
          </ul>

          <! Enable edit and delete buttons IF AND ONLY IF the user logged in owns that post>
          {% if post.username == session['username'] %}

          <! This keeps the optional edit and delete buttons outside the clickable wrapper section to open recipe_card.html>
          <div class="mt-2">
              <! Delete Button>
            <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" style="display:inline;">
              <button type="submit" class="btn btn-danger btn-sm">Delete</button>
            </form>

            <! Edit Button>
            <button type="button"
                    class="btn btn-warning btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#editModal"
                    data-id="{{ post.id }}"
                    data-title="{{ post.title }}"
                    data-category="{{ post.category }}"
                    data-ingredients="{{ post.ingredients | escape }}"
                    data-steps="{{ post.steps | escape }}"
                    data-appliances="{{ post.appliances | escape }}">
              Edit</button>
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}

      <! Adding a new recipe to database modal>
      <div class="modal fade" id="recipeModal" tabindex="-1" aria-labelledby="recipeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="POST" action="{{ url_for('submit_recipe') }}">
              <div class="modal-header">
                <h5 class="modal-title" id="recipeModalLabel">New Recipe Card</h5>
              </div>
              <div class="modal-body">

                <! Users insert their own recipe titel>
                <div class="mb-3">
                  <label for="recipeTitle" class="form-label">Title</label>
                  <input type="text" class="form-control" id="recipeTitle" name="title" required>
                </div>

                <! Enable labeling to later filter posts by>
                <div class="mb-3">
                  <label for="recipeCategory" class="form-label">Category</label>
                  <select class="form-select" id="recipeCategory" name="recipe_category" data-role="label" required>
                    <option selected disabled>Select a category</option>
                    <option>American</option>
                    <option>Chinese</option>
                    <option>Greek</option>
                    <option>Indian</option>
                    <option>Italian (Pizza)</option>
                    <option>Italian (Pasta)</option>
                    <option>Mexican</option>
                    <option>Seafood</option>
                    <option>Other</option>
                  </select>
                </div>

                  <! Insert ingredients>
                <div class="mb-3">
                  <label for="recipeIngredients" class="form-label">Ingredients & Measurements</label>
                  <textarea class="form-control" id="recipeIngredients" name="ingredients" rows="3" required></textarea>
                </div>

                  <! Insert Steps>
                <div class="mb-3">
                  <label for="recipeSteps" class="form-label">Steps</label>
                  <textarea class="form-control" id="recipeSteps" name="steps" rows="5" required></textarea>
                </div>

                <! Insert Appliances>
                <div class="mb-3">
                  <label for="recipeAppliances" class="form-label">Appliances Needed</label>
                  <textarea class="form-control" id="recipeAppliances" name="appliances" rows="4"></textarea>
                </div>
              </div>

                <! Submit button section>
              <div class="modal-footer">
                <button type="submit" class="btn btn-success">Post Recipe</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <! Ability to edit the modal and have it fully filled when you start editing>
      <! I (Jillian) had to look up some help from last exercise and on online to fix bugs for this>
      <! This is essentially the exact same set up as the original insert modal but will be filled with the pre-existing database information>
      <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="POST" action="{{ url_for('edit_post') }}">
              <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Recipe</h5>
              </div>
              <div class="modal-body">
                <input type="hidden" name="id" id="edit-id">
                <div class="mb-3">
                  <label for="edit-title" class="form-label">Title</label>
                  <input type="text" class="form-control" id="edit-title" name="title" required>
                </div>
                <div class="mb-3">
                  <label for="edit-category" class="form-label">Category</label>
                  <select class="form-select" id="edit-category" name="category" required>
                    <option>American</option>
                    <option>Chinese</option>
                    <option>Greek</option>
                    <option>Indian</option>
                    <option>Italian (Pizza)</option>
                    <option>Italian (Pasta)</option>
                    <option>Mexican</option>
                    <option>Seafood</option>
                    <option>Other</option>
                  </select>
                </div>
                  <! Ingredients>
                <div class="mb-3">
                  <label for="edit-ingredients" class="form-label">Ingredients & Measurements</label>
                  <textarea class="form-control" id="edit-ingredients" name="ingredients" rows="3" required></textarea>
                </div>
                  <! Steps>
                <div class="mb-3">
                  <label for="edit-steps" class="form-label">Steps</label>
                  <textarea class="form-control" id="edit-steps" name="steps" rows="5" required></textarea>
                </div>
                <! Appliances>
                <div class="mb-3">
                  <label for="edit-appliances" class="form-label">Appliances</label>
                  <textarea class="form-control" id="edit-appliances" name="appliances" rows="4" required></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-success">Update Recipe</button>
              </div>
            </form>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<! Section to have the edit modal be fully filled in with the pre-existing database information for users if permission is allowed>
<! I (Jillian) had to look up some help from last exercise and on online to fix bugs for this>
<script>
  const editModal = document.getElementById('editModal');
  editModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    document.getElementById('edit-id').value = button.getAttribute('data-id');
    document.getElementById('edit-title').value = button.getAttribute('data-title');
    document.getElementById('edit-category').value = button.getAttribute('data-category');
    document.getElementById('edit-ingredients').value = button.getAttribute('data-ingredients');
    document.getElementById('edit-steps').value = button.getAttribute('data-steps');
    document.getElementById('edit-appliances').value = button.getAttribute('data-appliances');});

    document.querySelectorAll('select[data-role="filter"]').forEach(select => {select.addEventListener('change', () => {select.form.submit();});});
</script>

{% endblock %}